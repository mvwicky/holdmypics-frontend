<script lang="ts">
  import type { ImageFormProps, Option, UpdateEvent } from "../typing";
  import { onlyTruthy } from "../helpers";

  import Row from "./Row.svelte";
  import HelpText from "./HelpText.svelte";
  import CustomSelect from "./CustomSelect.svelte";
  import ColorInput from "./ColorInput.svelte";

  export let props: ImageFormProps;

  let font: string = "overpass";
  let randomText: boolean = false;

  let form: HTMLFormElement;
  let textInput: HTMLInputElement | undefined;

  const updateFg = ({ detail }: UpdateEvent) => (props.fg = detail.value);
  const updateBg = ({ detail }: UpdateEvent) => (props.bg = detail.value);

  const randomChanged = () => textInput && (textInput.disabled = randomText);

  let textParam: string | undefined;
  $: textParam = textInput?.disabled
    ? undefined
    : props.text?.length ?? 0 > 0
    ? props.text
    : undefined;

  let params: string;
  $: params = new URLSearchParams(
    onlyTruthy([
      ["font", font],
      ["text", textParam],
      ["random_text", randomText ? "" : undefined],
    ])
  ).toString();
  let url: string;
  $: url = [
    "/api",
    `${props.width}x${props.height}`,
    props.bg,
    props.fg,
    props.fmt,
    `${params.length ? "?" : ""}${params}`,
  ].join("/");

  const fontOptions: Option[] = [
    { label: "", value: "" },
    { label: "Overpass", value: "overpass", selected: true },
    { label: "Fira Mono", value: "fira-mono" },
    { label: "Fira Sans", value: "fira-sans" },
    { label: "Roboto", value: "roboto" },
  ];
  const fmtOptions: Option[] = [
    { label: "png", value: "png", selected: true },
    { label: "jpg", value: "jpg" },
    { label: "jpeg", value: "jpeg" },
    { label: "gif", value: "gif" },
    { label: "webp", value: "webp" },
  ];
</script>

<style>
  .ImageForm {
    @apply w-full px-2;
  }

  .form-group {
    @apply pb-4 px-10;
    @apply w-full;
    @apply flex flex-row justify-between content-start;
    @apply items-baseline;
  }
  .form-group > * {
    flex: 0 0 50%;
    @apply block;
  }
  .input-group {
    @apply items-center;
  }
  input {
    @apply w-full;
    @apply shadow-sm;
    @apply border-2 border-gray-200 rounded;
    @apply py-1 px-2;
    @apply text-gray-700;
    @apply leading-tight;
  }
  input:not([type="checkbox"]) {
    @apply appearance-none;
  }
  input:focus {
    @apply outline-none bg-white border-indigo-500;
  }
  input:invalid {
    @apply border-red-500;
  }
</style>

<Row>
  <!-- <img
    src="https://holdmypics.com/api/638x328/cef/555/png/?text=Something+Funny&font=overpass"
    alt="Generated by this site" /> -->
  <img src="https://holdmypics.com/{url}" alt="Generated by this site" />
</Row>

<Row>
  <code class="overflow-hidden hover:underline cursor-pointer">{url}</code>
</Row>

<form bind:this={form} class="ImageForm">
  <div class="form-group">
    <label for="width">Width</label>
    <input
      type="number"
      id="width"
      name="width"
      step="1"
      min="1"
      bind:value={props.width} />
  </div>
  <div class="form-group">
    <label for="height">Height</label>
    <input
      type="number"
      id="height"
      name="height"
      step="1"
      min="1"
      bind:value={props.height} />
  </div>
  <div class="form-group">
    <ColorInput
      label="Foreground Color"
      id="fg"
      value={props.fg}
      on:update={updateFg} />
  </div>
  <div class="form-group">
    <ColorInput
      label="Background Color"
      id="bg"
      value={props.bg}
      on:update={updateBg} />
  </div>

  <div class="form-group">
    <label for="fmt">Format</label>
    <div class="input-group">
      <CustomSelect id="fmt" options={fmtOptions} bind:value={props.fmt} />
      <HelpText><q>jpg</q> and <q>jpeg</q> are equivalent.</HelpText>
    </div>
  </div>

  <div class="form-group">
    <label for="font">Font</label>
    <div class="input-group">
      <CustomSelect id="font" options={fontOptions} bind:value={font} />
      <HelpText>The font of the text.</HelpText>
    </div>
  </div>

  <div id="text-row" class="form-group">
    <label for="text">Text</label>
    <input
      class="pr-0 mr-0 flex-grow"
      type="text"
      id="text"
      name="text"
      bind:this={textInput}
      bind:value={props.text}
      spellcheck={false} />
  </div>
  <div class="form-group" id="random-text-row">
    <label for="randomText">Random Text</label>
    <div>
      <input
        class="ml-0"
        name="randomText"
        id="randomText"
        type="checkbox"
        bind:checked={randomText}
        on:change={randomChanged} />
      <HelpText>&nbsp;</HelpText>
    </div>
  </div>
</form>
